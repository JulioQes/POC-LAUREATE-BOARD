name: Cross-Repo Branch Dispatcher (BE/FE)

on:
  issues:
    types: [labeled]

jobs:
  create_cross_repo_branch:
    runs-on: ubuntu-latest

    if: |
      contains(toJson(github.event.issue.labels.*.name), 'BE') ||
      contains(toJson(github.event.issue.labels.*.name), 'FE')

    steps:
      - name: Create Branch in Target Repo + Link to Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const owner = 'JulioQes';
            const baseBranch = 'main';

            // ----- 1. Determine BE or FE -----
            const labels = context.payload.issue.labels.map(label => label.name);
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 30);

            let targetRepo = '';
            let branchPrefix = '';

            if (labels.includes('BE')) {
              targetRepo = 'POC-LAUREATE-BOARD-BE';
              branchPrefix = 'be/';
            } else if (labels.includes('FE')) {
              targetRepo = 'POC-LAUREATE-BOARD-FE';
              branchPrefix = 'fe/';
            } else {
              console.log("No BE/FE label detected â€” skipping.");
              return;
            }

            const newBranchName = `${branchPrefix}issue-${issueNumber}-${issueTitle}`;


            try {
              // ----- 2. Get SHA of main branch in BE/FE -----
              const { data: refData } = await github.rest.git.getRef({
                owner,
                repo: targetRepo,
                ref: `heads/${baseBranch}`
              });

              const sha = refData.object.sha;


              // ----- 3. Create the new branch in BE/FE -----
              await github.rest.git.createRef({
                owner,
                repo: targetRepo,
                ref: `refs/heads/${newBranchName}`,
                sha
              });


              // ----- 4. LINK BRANCH TO THE ORIGINAL ISSUE (REAL MAGIC) -----
              // Works only because WF + BE + FE repos are tied into the same Project V2.
              await github.rest.repos.createOrUpdateIssueBranch({
                owner,                 // repo where the BRANCH lives
                repo: targetRepo,      // BE/FE repo
                issue_number: issueNumber,   // Issue in WF repo
                head_branch: newBranchName
              });


              // ----- 5. Add comment to original Issue -----
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `
 **Branch created & linked automatically!**

**Repository:** \`${owner}/${targetRepo}\`  
**Branch:** \`${newBranchName}\`

This branch is now associated with this Issue under **Development**.
You may begin implementing changes on this branch.
                `
              });


            } catch (error) {
              core.setFailed(error.message);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `
 **Error creating or linking branch**

\`${error.message}\`
                `
              });
            }