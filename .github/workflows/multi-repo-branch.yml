name: Cross-Repo Branch Dispatcher (BE/FE)

on:
  # Trigger: When an Issue is opened or labels are added/modified.
  issues:
    types: [opened, labeled]

jobs:
  create_cross_repo_branch:
    runs-on: ubuntu-latest
    
    # Job Condition: Proceed only if a relevant label (BE or FE) is present in the Issue.
    if: |
      contains(toJson(github.event.issue.labels.*.name), 'BE') ||
      contains(toJson(github.event.issue.labels.*.name), 'FE')

    steps:
      - name:  Create Branch in Target Repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }} 
          script: |
            const { github, context, core } = require('@actions/github');
            const owner = 'JulioQes';
            const baseBranch = 'main'; // Target base branch (e.g., 'main' or 'dev')

            // 1. Identify labels and define the target repository
            const labels = context.payload.issue.labels.map(label => label.name);
            let targetRepo = '';
            let branchPrefix = '';
            
            if (labels.includes('BE')) {
                targetRepo = 'POC-LAUREATE-BOARD-BE';
                branchPrefix = 'be/';
            } else if (labels.includes('FE')) {
                targetRepo = 'POC-LAUREATE-BOARD-FE';
                branchPrefix = 'fe/';
            } else {
                // If a relevant label is not found (e.g., a ticket was just opened without a label), exit.
                console.log('No target label (BE or FE) found. Skipping branch creation.');
                return;
            }

            // 2. Format the branch name (Example: fe/issue-123-task-title)
            const issueNumber = context.payload.issue.number;
            // Clean up the title for use in a branch name
            const issueTitle = context.payload.issue.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-*|-*$/g, '').substring(0, 30);
            const newBranchName = `${branchPrefix}issue-${issueNumber}-${issueTitle}`;
            
            // 3. Get the SHA of the base branch ('main') from the target repository
            console.log(`Fetching SHA for ${baseBranch} in ${targetRepo}`);
            try {
                const { data: refData } = await github.rest.git.getRef({
                    owner: owner,
                    repo: targetRepo,
                    ref: `heads/${baseBranch}`,
                });
                const sha = refData.object.sha;
                
            // 4. Create the new branch (reference) in the target repository
            console.log(`Creating branch ${newBranchName} in ${targetRepo} with SHA ${sha}`);
            await